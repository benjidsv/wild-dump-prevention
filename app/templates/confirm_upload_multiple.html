{% extends "base.html" %}
{% block title %}Confirmation Upload Multiple{% endblock %}
{% block content %}

<h2 class="mb-4">Confirmer les images uploadées</h2>

<form method="POST" action="{{ url_for('main.confirm_upload_multiple') }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  {% for filename in filenames %}
  <div class="card mb-3 upload-card"
       data-idx="{{ loop.index0 }}"
       data-auto-label="{{ auto_labels[loop.index0] }}"
       data-auto-timestamp="{{ auto_timestamps[loop.index0] }}"
       data-auto-location="{{ auto_locations[loop.index0] }}">

    <div class="card-body">
      <h5 class="card-title">{{ filename }}</h5>

      <img src="{{ url_for('static', filename='uploads/' + filename) }}"
           class="img-fluid mb-3" style="max-height:300px;" alt="Image uploadée">

      <!-- ---------- hidden inputs ---------- -->
      <input type="hidden" name="filenames" value="{{ filename }}">

      <input type="hidden" name="label_manual_{{ loop.index0 }}"     id="label_manual_{{ loop.index0 }}">
      <input type="hidden" name="timestamp_manual_{{ loop.index0 }}" id="timestamp_manual_{{ loop.index0 }}">
      <input type="hidden" name="location_manual_{{ loop.index0 }}"  id="location_manual_{{ loop.index0 }}">
      <input type="hidden" name="is_manual_{{ loop.index0 }}"        id="is_manual_{{ loop.index0 }}">

      <!-- ---------- Label ---------- -->
      <div class="mb-3">
        <label class="form-label">État de la poubelle</label>
        <div class="d-flex align-items-stretch gap-2">
          <select name="label_{{ loop.index0 }}" id="label_{{ loop.index0 }}" class="form-select flex-grow-1">
            <option value="full">Pleine</option>
            <option value="empty">Vide</option>
          </select>

          <span id="label-badge_{{ loop.index0 }}"  class="badge-auto">Auto</span>

          <button type="button" class="btn btn-outline-secondary"
                  id="label-reset_{{ loop.index0 }}" disabled>Réinitialiser</button>
        </div>
      </div>

      <!-- ---------- Timestamp ---------- -->
      <div class="mb-3">
        <label class="form-label" for="timestamp_{{ loop.index0 }}">Date/Heure</label>
        <div class="d-flex align-items-stretch gap-2">
          <input type="datetime-local" name="timestamp_{{ loop.index0 }}"
                 id="timestamp_{{ loop.index0 }}" class="form-control flex-grow-1">

          <span id="timestamp-badge_{{ loop.index0 }}" class="badge-auto">Auto</span>

          <button type="button" class="btn btn-outline-secondary"
                  id="timestamp-reset_{{ loop.index0 }}" disabled>Réinitialiser</button>
        </div>

        <div id="timestamp-warning_{{ loop.index0 }}"
             class="form-text text-warning d-none">
          <i class="bi bi-exclamation-triangle-fill me-1"></i>
          Aucun horodatage détecté automatiquement&nbsp;: veuillez saisir une valeur.
        </div>
      </div>

      <!-- ---------- Location ---------- -->
      <div class="mb-3">
        <label class="form-label" for="location_{{ loop.index0 }}">Localisation</label>
        <div class="d-flex align-items-stretch gap-2">
          <input type="text" name="location_{{ loop.index0 }}"
                 id="location_{{ loop.index0 }}" class="form-control flex-grow-1"
                 placeholder="Adresse ou coordonnées GPS">

          <span id="location-badge_{{ loop.index0 }}" class="badge-auto">Auto</span>

          <button type="button" class="btn btn-outline-secondary"
                  id="location-reset_{{ loop.index0 }}" disabled>Réinitialiser</button>
        </div>

        <div id="location-warning_{{ loop.index0 }}"
             class="form-text text-warning d-none">
          <i class="bi bi-exclamation-triangle-fill me-1"></i>
          Aucune localisation détectée automatiquement&nbsp;: veuillez saisir une valeur.
        </div>
      </div>

    </div>
  </div>
  {% endfor %}

  <div class="text-end">
    <button type="submit" class="btn btn-success">Valider</button>
  </div>
</form>

<style>
.badge-auto{
  width:100px;height:38px;background:#0dcaf0;
  display:flex;align-items:center;justify-content:center;
  font-family:system-ui,sans-serif;font-weight:700;color:#fff;padding:0
}
#suggestions{
  border:1px solid #ccc;
  max-width:300px;
  position:absolute;
  background-color:#fff;
  z-index:1000
}
#suggestions div{
  padding:8px;
  cursor:pointer
}
#suggestions div:hover{
  background-color:#f0f0f0
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {

  document.querySelectorAll('.upload-card').forEach(card => {
    const idx             = card.dataset.idx;
    const autoLabel       = card.dataset.autoLabel     || 'full';
    const autoTimestamp   = card.dataset.autoTimestamp || '';
    const autoLocation    = card.dataset.autoLocation  || '';

    // ---- form fields ----------------------------------------------------
    const labelSelect     = card.querySelector(`#label_${idx}`);
    const tsInput         = card.querySelector(`#timestamp_${idx}`);
    const locInput        = card.querySelector(`#location_${idx}`);

    const labelManField   = card.querySelector(`#label_manual_${idx}`);
    const tsManField      = card.querySelector(`#timestamp_manual_${idx}`);
    const locManField     = card.querySelector(`#location_manual_${idx}`);
    const isManField      = card.querySelector(`#is_manual_${idx}`);

    // ---- visual helpers -------------------------------------------------
    const labelBadge      = card.querySelector(`#label-badge_${idx}`);
    const tsBadge         = card.querySelector(`#timestamp-badge_${idx}`);
    const locBadge        = card.querySelector(`#location-badge_${idx}`);

    const labelReset      = card.querySelector(`#label-reset_${idx}`);
    const tsReset         = card.querySelector(`#timestamp-reset_${idx}`);
    const locReset        = card.querySelector(`#location-reset_${idx}`);

    const tsWarn          = card.querySelector(`#timestamp-warning_${idx}`);
    const locWarn         = card.querySelector(`#location-warning_${idx}`);

    const autoC  = '#0dcaf0';
    const manuC  = '#6c757d';

    function refresh() {
      const labelChanged = labelSelect.value !== autoLabel;
      const tsChanged    = tsInput.value     !== autoTimestamp;
      const locChanged   = locInput.value    !== autoLocation;

      // --- write strings so Flask gets them -----------------------------
      labelManField.value = labelChanged ? "true" : "false";
      tsManField.value    = tsChanged    ? "true" : "false";
      locManField.value   = locChanged   ? "true" : "false";
      isManField.value    = (labelChanged || tsChanged || locChanged) ? "true" : "false";

      // --- badges -------------------------------------------------------
      labelBadge.textContent = labelChanged ? 'Manuel' : 'Auto';
      labelBadge.style.backgroundColor = labelChanged ? manuC : autoC;

      tsBadge.textContent = tsChanged ? 'Manuel' : 'Auto';
      tsBadge.style.backgroundColor   = tsChanged ? manuC : autoC;

      locBadge.textContent = locChanged ? 'Manuel' : 'Auto';
      locBadge.style.backgroundColor  = locChanged ? manuC : autoC;

      // --- reset buttons & warnings -------------------------------------
      labelReset.disabled = !labelChanged;
      tsReset.disabled    = !tsChanged;
      locReset.disabled   = !locChanged;

      tsWarn.classList.toggle('d-none', !(autoTimestamp === '' && tsInput.value === ''));
      locWarn.classList.toggle('d-none', !(autoLocation  === '' && locInput.value === ''));
    }

    /* --------- wired actions --------- */
    labelReset.addEventListener('click', () => { labelSelect.value = autoLabel; refresh(); });
    tsReset.addEventListener   ('click', () => { tsInput.value     = autoTimestamp; refresh(); });
    locReset.addEventListener  ('click', () => { locInput.value    = autoLocation;  refresh(); });

    labelSelect.addEventListener('change', refresh);
    tsInput.addEventListener    ('input',  refresh);
    locInput.addEventListener   ('input',  refresh);

    // initial fill
    labelSelect.value = autoLabel;
    tsInput.value     = autoTimestamp;
    locInput.value    = autoLocation;
    refresh();
  });

  /* --------- Autocomplétion d'adresse --------- */
  const suggestionsBox = document.createElement('div');
  suggestionsBox.id = 'suggestions';
  document.body.appendChild(suggestionsBox);

  const addrCache = {};
  let addrTimer;

  function showAddrSuggestions(addrs, targetInput) {
    suggestionsBox.innerHTML = '';
    if (addrs.length === 0) {
      suggestionsBox.style.display = 'none';
      return;
    }
    addrs.forEach(addr => {
      const div = document.createElement('div');
      div.textContent = addr;
      div.addEventListener('click', () => {
        targetInput.value = addr;
        targetInput.dispatchEvent(new Event('input', { bubbles: true }));
        suggestionsBox.style.display = 'none';
      });
      suggestionsBox.appendChild(div);
    });
    const rect = targetInput.getBoundingClientRect();
    suggestionsBox.style.left = (rect.left + window.scrollX) + 'px';
    suggestionsBox.style.top  = (rect.bottom + window.scrollY) + 'px';
    suggestionsBox.style.width = rect.width + 'px';
    suggestionsBox.style.display = 'block';
  }

  function fetchAddr(query, targetInput) {
    if (addrCache[query]) {
      showAddrSuggestions(addrCache[query], targetInput);
      return;
    }
    fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`)
      .then(res => res.json())
      .then(data => {
        const results = data.features.map(f => f.properties.label);
        addrCache[query] = results;
        showAddrSuggestions(results, targetInput);
      });
  }

  document.querySelectorAll('input[id^="location_"]').forEach(input => {
    input.addEventListener('input', (e) => {
      if (!e.isTrusted) return; // Ignore programmatic changements (sélection)
      clearTimeout(addrTimer);
      const q = input.value.trim();
      if (q.length < 3) {
        suggestionsBox.style.display = 'none';
        return;
      }
      addrTimer = setTimeout(() => fetchAddr(q, input), 400);
    });
    input.addEventListener('blur', () => {
      setTimeout(() => {
        suggestionsBox.style.display = 'none';
      }, 200);
    });
  });

});
</script>

{% endblock %}
