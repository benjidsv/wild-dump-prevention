{% extends "base.html" %}

{% block title %}Confirmation Upload Multiple{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/confirm_upload_multiple.css') }}">
{% endblock %}

{% block content %}

<!-- Environmental Header -->
<div class="header confirm-multiple-header confirm-multiple-fade-in">
    <div class="row align-items-center justify-content-center text-center">
        <div class="col-md-8">
            <h1 class="confirm-multiple-title">
                <div class="confirm-multiple-icon">
                    <i class="bi bi-images"></i>
                </div>
                Finaliser vos Contributions
            </h1>
            <p class="confirm-multiple-subtitle">
                Vérifiez et validez les informations détectées pour chaque image de surveillance environnementale
            </p>
            <div class="confirm-multiple-stats">
                <i class="bi bi-camera-fill"></i>
                {{ filenames|length }} image{{ 's' if filenames|length > 1 else '' }} à traiter
            </div>
        </div>
    </div>
</div>

<h2 class="confirm-multiple-page-title">Confirmer les images uploadées</h2>

<form method="POST" action="{{ url_for('main.confirm_upload_multiple') }}" class="confirm-multiple-slide-up">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    {% for filename in filenames %}
    <div class="upload-card upload-card-animate"
         data-idx="{{ loop.index0 }}"
         data-auto-label="{{ auto_labels[loop.index0] }}"
         data-auto-timestamp="{{ auto_timestamps[loop.index0] }}"
         data-auto-location="{{ auto_locations[loop.index0] }}">

        <div class="card-body">
            <h5 class="card-title">{{ filename }}</h5>

            <!-- Image Preview -->
            <div class="upload-card-image-preview">
                <img src="{{ url_for('static', filename='uploads/' + filename) }}"
                     class="upload-card-image" alt="Image uploadée">
            </div>

            <!-- Hidden inputs -->
            <input type="hidden" name="filenames" value="{{ filename }}">
            <input type="hidden" name="label_manual_{{ loop.index0 }}" id="label_manual_{{ loop.index0 }}">
            <input type="hidden" name="timestamp_manual_{{ loop.index0 }}" id="timestamp_manual_{{ loop.index0 }}">
            <input type="hidden" name="location_manual_{{ loop.index0 }}" id="location_manual_{{ loop.index0 }}">
            <input type="hidden" name="is_manual_{{ loop.index0 }}" id="is_manual_{{ loop.index0 }}">

            <!-- Label Field -->
            <div class="upload-card-form-group">
                <label class="upload-card-form-label">
                    <i class="bi bi-trash"></i>État de la poubelle
                </label>
                <div class="upload-card-input-row">
                    <select name="label_{{ loop.index0 }}" id="label_{{ loop.index0 }}" class="upload-card-form-control">
                        <option value="full">Pleine</option>
                        <option value="empty">Vide</option>
                    </select>
                    <span id="label-badge_{{ loop.index0 }}" class="upload-card-badge badge-auto">Auto</span>
                    <button type="button" class="upload-card-reset-btn" id="label-reset_{{ loop.index0 }}" disabled>
                        Réinitialiser
                    </button>
                </div>
            </div>

            <!-- Timestamp Field -->
            <div class="upload-card-form-group">
                <label class="upload-card-form-label" for="timestamp_{{ loop.index0 }}">
                    <i class="bi bi-clock"></i>Date/Heure
                </label>
                <div class="upload-card-input-row">
                    <input type="datetime-local" name="timestamp_{{ loop.index0 }}" 
                           id="timestamp_{{ loop.index0 }}" class="upload-card-form-control">
                    <span id="timestamp-badge_{{ loop.index0 }}" class="upload-card-badge badge-auto">Auto</span>
                    <button type="button" class="upload-card-reset-btn" id="timestamp-reset_{{ loop.index0 }}" disabled>
                        Réinitialiser
                    </button>
                </div>
                <div id="timestamp-warning_{{ loop.index0 }}" class="upload-card-warning d-none">
                    Aucun horodatage détecté automatiquement : veuillez saisir une valeur.
                </div>
            </div>

            <!-- Location Field -->
            <div class="upload-card-form-group">
                <label class="upload-card-form-label" for="location_{{ loop.index0 }}">
                    <i class="bi bi-geo-alt"></i>Localisation
                </label>
                <div class="upload-card-input-row">
                    <input type="text" name="location_{{ loop.index0 }}" 
                           id="location_{{ loop.index0 }}" class="upload-card-form-control"
                           placeholder="Adresse ou coordonnées GPS">
                    <span id="location-badge_{{ loop.index0 }}" class="upload-card-badge badge-auto">Auto</span>
                    <button type="button" class="upload-card-reset-btn" id="location-reset_{{ loop.index0 }}" disabled>
                        Réinitialiser
                    </button>
                </div>
                <div id="location-warning_{{ loop.index0 }}" class="upload-card-warning d-none">
                    Aucune localisation détectée automatiquement : veuillez saisir une valeur.
                </div>
            </div>

        </div>
    </div>
    {% endfor %}

    <!-- Submit Section -->
    <div class="confirm-multiple-submit-section">
        <button type="submit" class="confirm-multiple-btn-submit">
            <i class="bi bi-check-circle-fill me-2"></i>
            Valider toutes les images
        </button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {

  document.querySelectorAll('.upload-card').forEach(card => {
    const idx             = card.dataset.idx;
    const autoLabel       = card.dataset.autoLabel     || 'full';
    const autoTimestamp   = card.dataset.autoTimestamp || '';
    const autoLocation    = card.dataset.autoLocation  || '';

    // ---- form fields ----------------------------------------------------
    const labelSelect     = card.querySelector(`#label_${idx}`);
    const tsInput         = card.querySelector(`#timestamp_${idx}`);
    const locInput        = card.querySelector(`#location_${idx}`);

    const labelManField   = card.querySelector(`#label_manual_${idx}`);
    const tsManField      = card.querySelector(`#timestamp_manual_${idx}`);
    const locManField     = card.querySelector(`#location_manual_${idx}`);
    const isManField      = card.querySelector(`#is_manual_${idx}`);

    // ---- visual helpers -------------------------------------------------
    const labelBadge      = card.querySelector(`#label-badge_${idx}`);
    const tsBadge         = card.querySelector(`#timestamp-badge_${idx}`);
    const locBadge        = card.querySelector(`#location-badge_${idx}`);

    const labelReset      = card.querySelector(`#label-reset_${idx}`);
    const tsReset         = card.querySelector(`#timestamp-reset_${idx}`);
    const locReset        = card.querySelector(`#location-reset_${idx}`);

    const tsWarn          = card.querySelector(`#timestamp-warning_${idx}`);
    const locWarn         = card.querySelector(`#location-warning_${idx}`);

    function refresh() {
      const labelChanged = labelSelect.value !== autoLabel;
      const tsChanged    = tsInput.value     !== autoTimestamp;
      const locChanged   = locInput.value    !== autoLocation;

      // --- write strings so Flask gets them -----------------------------
      labelManField.value = labelChanged ? "true" : "false";
      tsManField.value    = tsChanged    ? "true" : "false";
      locManField.value   = locChanged   ? "true" : "false";
      isManField.value    = (labelChanged || tsChanged || locChanged) ? "true" : "false";

      // --- badges with new class system ---------------------------------
      labelBadge.textContent = labelChanged ? 'Manuel' : 'Auto';
      labelBadge.className = labelChanged ? 'upload-card-badge badge-manual' : 'upload-card-badge badge-auto';

      tsBadge.textContent = tsChanged ? 'Manuel' : 'Auto';
      tsBadge.className = tsChanged ? 'upload-card-badge badge-manual' : 'upload-card-badge badge-auto';

      locBadge.textContent = locChanged ? 'Manuel' : 'Auto';
      locBadge.className = locChanged ? 'upload-card-badge badge-manual' : 'upload-card-badge badge-auto';

      // --- reset buttons & warnings -------------------------------------
      labelReset.disabled = !labelChanged;
      tsReset.disabled    = !tsChanged;
      locReset.disabled   = !locChanged;

      tsWarn.classList.toggle('d-none', !(autoTimestamp === '' && tsInput.value === ''));
      locWarn.classList.toggle('d-none', !(autoLocation  === '' && locInput.value === ''));
    }

    /* --------- wired actions --------- */
    labelReset.addEventListener('click', () => { labelSelect.value = autoLabel; refresh(); });
    tsReset.addEventListener   ('click', () => { tsInput.value     = autoTimestamp; refresh(); });
    locReset.addEventListener  ('click', () => { locInput.value    = autoLocation;  refresh(); });

    labelSelect.addEventListener('change', refresh);
    tsInput.addEventListener    ('input',  refresh);
    locInput.addEventListener   ('input',  refresh);

    // initial fill
    labelSelect.value = autoLabel;
    tsInput.value     = autoTimestamp;
    locInput.value    = autoLocation;
    refresh();
  });

  /* --------- Autocomplétion d'adresse --------- */
  const suggestionsBox = document.createElement('div');
  suggestionsBox.className = 'confirm-multiple-suggestions';
  suggestionsBox.id = 'suggestions';
  document.body.appendChild(suggestionsBox);

  const addrCache = {};
  let addrTimer;

  function showAddrSuggestions(addrs, targetInput) {
    suggestionsBox.innerHTML = '';
    if (addrs.length === 0) {
      suggestionsBox.style.display = 'none';
      return;
    }
    addrs.forEach(addr => {
      const div = document.createElement('div');
      div.textContent = addr;
      div.addEventListener('click', () => {
        targetInput.value = addr;
        targetInput.dispatchEvent(new Event('input', { bubbles: true }));
        suggestionsBox.style.display = 'none';
      });
      suggestionsBox.appendChild(div);
    });
    const rect = targetInput.getBoundingClientRect();
    suggestionsBox.style.left = (rect.left + window.scrollX) + 'px';
    suggestionsBox.style.top  = (rect.bottom + window.scrollY) + 'px';
    suggestionsBox.style.width = rect.width + 'px';
    suggestionsBox.style.display = 'block';
  }

  function fetchAddr(query, targetInput) {
    if (addrCache[query]) {
      showAddrSuggestions(addrCache[query], targetInput);
      return;
    }
    fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`)
      .then(res => res.json())
      .then(data => {
        const results = data.features.map(f => f.properties.label);
        addrCache[query] = results;
        showAddrSuggestions(results, targetInput);
      });
  }

  document.querySelectorAll('input[id^="location_"]').forEach(input => {
    input.addEventListener('input', (e) => {
      if (!e.isTrusted) return; // Ignore programmatic changements (sélection)
      clearTimeout(addrTimer);
      const q = input.value.trim();
      if (q.length < 3) {
        suggestionsBox.style.display = 'none';
        return;
      }
      addrTimer = setTimeout(() => fetchAddr(q, input), 400);
    });
    input.addEventListener('blur', () => {
      setTimeout(() => {
        suggestionsBox.style.display = 'none';
      }, 200);
    });
  });

});
</script>

{% endblock %}
