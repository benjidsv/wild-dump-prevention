{% extends "base.html" %}
{% block title %}Confirmer l'envoi{% endblock %}
{% block content %}

<h2>Vérifiez l’image et ses données</h2>

<img src="{{ url_for('static', filename='uploads/' + filename) }}" class="img-fluid mb-3" style="max-height: 300px;" alt="Image uploadée">

<form method="POST" action="{{ url_for('main.confirm_upload') }}">
  <input type="hidden" name="filename" value="{{ filename }}">
  <input type="hidden" name="is_manual" id="is_manual" value="false">

  <!-- Label -->
  <div class="mb-3">
    <label for="label" class="form-label">État de la poubelle</label>
    <div class="d-flex align-items-stretch gap-2">
      <select name="label" id="label" class="form-select flex-grow-1">
        <option value="full">Pleine</option>
        <option value="empty">Vide</option>
      </select>

      <span id="label-badge" class="btn fw-bold text-white text-center px-0 badge-auto" style="width:100px;height:38px;">Auto</span>

      <button type="button" class="btn btn-outline-secondary" id="label-reset" disabled>Réinitialiser</button>
    </div>
  </div>

  <!-- Timestamp -->
  <div class="mb-3">
    <label for="timestamp" class="form-label">Date/Heure</label>
    <div class="d-flex align-items-stretch gap-2">
      <input type="datetime-local" name="timestamp" id="timestamp" class="form-control flex-grow-1">

      <span id="timestamp-badge" class="btn fw-bold text-white text-center px-0 badge-auto" style="width:100px;height:38px;">Auto</span>

      <button type="button" class="btn btn-outline-secondary" id="timestamp-reset" disabled>Réinitialiser</button>
    </div>
    <div id="timestamp-warning" class="form-text text-warning d-none">Aucun horodatage détecté automatiquement&nbsp;: veuillez saisir une valeur.</div>
  </div>

  <!-- Location -->
  <div class="mb-3">
    <label for="location" class="form-label">Localisation</label>
    <div class="d-flex align-items-stretch gap-2">
      <input type="text" name="location" id="location" class="form-control flex-grow-1" placeholder="Adresse ou coordonnées GPS">

      <span id="location-badge" class="btn fw-bold text-white text-center px-0 badge-auto" style="width:100px;height:38px;">Auto</span>

      <button type="button" class="btn btn-outline-secondary" id="location-reset" disabled>Réinitialiser</button>
    </div>
    <div id="location-warning" class="form-text text-warning d-none">Aucune localisation détectée automatiquement&nbsp;: veuillez saisir une valeur.</div>
  </div>

  <button type="submit" class="btn btn-success">Valider l’image</button>
  <a href="{{ url_for('main.upload') }}" class="btn btn-link">Annuler</a>
</form>

<style>
  .badge-auto{
    background-color:#0dcaf0;
    pointer-events:none;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family:system-ui,sans-serif;
    padding:0;
    line-height:1;
  }
</style>

<script>
// Valeurs détectées automatiquement injectées par le serveur
const autoLabel = "{{ auto_label }}";
const autoTimestamp = "{{ auto_timestamp or '' }}";
const autoLocation = "{{ auto_location or '' }}";

// Éléments DOM
const labelSelect = document.getElementById('label');
const timestampInput = document.getElementById('timestamp');
const locationInput = document.getElementById('location');
const isManualField = document.getElementById('is_manual');

const labelResetBtn = document.getElementById('label-reset');
const timestampResetBtn = document.getElementById('timestamp-reset');
const locationResetBtn = document.getElementById('location-reset');

const labelBadge = document.getElementById('label-badge');
const timestampBadge = document.getElementById('timestamp-badge');
const locationBadge = document.getElementById('location-badge');

const timestampWarning = document.getElementById('timestamp-warning');
const locationWarning = document.getElementById('location-warning');

function updateUI(){
  const labelChanged = labelSelect.value !== autoLabel;
  const timestampChanged = timestampInput.value !== autoTimestamp;
  const locationChanged = locationInput.value !== autoLocation;

  isManualField.value = (labelChanged || timestampChanged || locationChanged) ? 'true' : 'false';

  const autoColor = '#0dcaf0';
  const manualColor = '#6c757d';

  labelBadge.textContent = labelChanged ? 'Manuel' : 'Auto';
  labelBadge.style.backgroundColor = labelChanged ? manualColor : autoColor;

  timestampBadge.textContent = timestampChanged ? 'Manuel' : 'Auto';
  timestampBadge.style.backgroundColor = timestampChanged ? manualColor : autoColor;

  locationBadge.textContent = locationChanged ? 'Manuel' : 'Auto';
  locationBadge.style.backgroundColor = locationChanged ? manualColor : autoColor;

  labelResetBtn.disabled = !labelChanged;
  timestampResetBtn.disabled = !timestampChanged;
  locationResetBtn.disabled = !locationChanged;

  const showTimestampWarning = autoTimestamp === '' && timestampInput.value === '';
  const showLocationWarning = autoLocation === '' && locationInput.value === '';
  timestampWarning.classList.toggle('d-none', !showTimestampWarning);
  locationWarning.classList.toggle('d-none', !showLocationWarning);
}

function resetLabel(){labelSelect.value = autoLabel; updateUI();}
function resetTimestamp(){timestampInput.value = autoTimestamp; updateUI();}
function resetLocation(){locationInput.value = autoLocation; updateUI();}

window.addEventListener('DOMContentLoaded', ()=>{
  labelSelect.value = autoLabel;
  timestampInput.value = autoTimestamp;
  locationInput.value = autoLocation;
  updateUI();

  // Listeners
  labelSelect.addEventListener('change', updateUI);
  timestampInput.addEventListener('input', updateUI);
  locationInput.addEventListener('input', updateUI);

  // Reset buttons
  labelResetBtn.addEventListener('click', resetLabel);
  timestampResetBtn.addEventListener('click', resetTimestamp);
  locationResetBtn.addEventListener('click', resetLocation);
});
</script>

{% endblock %}
