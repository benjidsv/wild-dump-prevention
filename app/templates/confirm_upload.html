{% extends "base.html" %}
{% block title %}Confirmer l'envoi{% endblock %}
{% block content %}

<h2>Vérifiez l’image et ses données</h2>

<img src="{{ url_for('static', filename='uploads/' + filename) }}" class="img-fluid mb-3" style="max-height: 300px;">

<form method="POST" action="{{ url_for('main.confirm_upload') }}">
  <input type="hidden" name="filename" value="{{ filename }}">
  <input type="hidden" name="is_manual" id="is_manual" value="false">

  <!-- Label -->
    <div class="mb-3">
      <div class="mb-3">
    <label for="label" class="form-label">État de la poubelle</label>
    <div class="d-flex align-items-stretch gap-2">
      <select name="label" id="label" class="form-select flex-grow-1">
        <option value="full">Pleine</option>
        <option value="empty">Vide</option>
      </select>

      <span id="label-badge"
      class="btn fw-bold text-white text-center px-0"
      style="
        background-color: #0dcaf0;
        pointer-events: none;
        width: 100px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: system-ui, sans-serif;
        padding: 0;
        line-height: 1;
      ">
  auto
</span>



      <button type="button"
              class="btn btn-outline-secondary"
              id="label-reset"
              onclick="resetLabel()"
              disabled>
        Réinitialiser
      </button>
    </div>
  </div>


  <!-- Timestamp -->
  <div class="mb-3 d-flex align-items-end">
    <div class="flex-grow-1 me-2">
      <label for="timestamp" class="form-label">Date/Heure</label>
      <input type="datetime-local" name="timestamp" id="timestamp" class="form-control">
    </div>
    <div>
      <button type="button" class="btn btn-outline-secondary" id="timestamp-reset" onclick="resetTimestamp()" disabled>
        Réinitialiser
      </button>
    </div>
  </div>

  <!-- Location -->
  <div class="mb-3 d-flex align-items-end">
    <div class="flex-grow-1 me-2">
      <label for="location" class="form-label">Localisation</label>
      <input type="text" name="location" id="location" class="form-control" placeholder="Adresse ou coordonnées GPS">
    </div>
    <div>
      <button type="button" class="btn btn-outline-secondary" id="location-reset" onclick="resetLocation()" disabled>
        Réinitialiser
      </button>
    </div>
  </div>

  <button type="submit" class="btn btn-success">Valider l’image</button>
  <a href="{{ url_for('main.upload') }}" class="btn btn-link">Annuler</a>
</form>

<script>
  // Pre-filled values injected server-side
  const autoDetectedLabel = "{{ auto_label }}";
  const autoDetectedLocation = "{{ auto_location or '' }}";
  const defaultTimestamp = "{{ default_timestamp }}";

  // DOM elements
  const labelSelect = document.getElementById("label");
  const timestampInput = document.getElementById("timestamp");
  const locationInput = document.getElementById("location");
  const isManualField = document.getElementById("is_manual");

  const labelResetBtn = document.getElementById("label-reset");
  const timestampResetBtn = document.getElementById("timestamp-reset");
  const locationResetBtn = document.getElementById("location-reset");
  const labelBadge = document.getElementById("label-badge");

  // Applies state: badge, hidden field, buttons
  function updateUI() {
  const labelChanged = labelSelect.value !== autoDetectedLabel;
  const timestampChanged = timestampInput.value !== defaultTimestamp;
  const locationChanged = locationInput.value !== autoDetectedLocation;

  isManualField.value = labelChanged ? "true" : "false";

  // Update badge
  labelBadge.textContent = labelChanged ? "Manuel" : "Auto";
  labelBadge.style.backgroundColor = labelChanged ? "#6c757d" : "#0dcaf0";

  // Reset buttons
  labelResetBtn.disabled = !labelChanged;
  timestampResetBtn.disabled = !timestampChanged;
  locationResetBtn.disabled = !locationChanged;
}

  // Reset functions
  function resetLabel() {
    labelSelect.value = autoDetectedLabel;
    updateUI();
  }

  function resetTimestamp() {
    timestampInput.value = defaultTimestamp;
    updateUI();
  }

  function resetLocation() {
    locationInput.value = autoDetectedLocation;
    updateUI();
  }

  // Initialize on page load
  window.addEventListener("DOMContentLoaded", () => {
    labelSelect.value = autoDetectedLabel;
    timestampInput.value = defaultTimestamp;
    locationInput.value = autoDetectedLocation;
    updateUI();
  });

  // Event listeners
  labelSelect.addEventListener("change", updateUI);
  timestampInput.addEventListener("input", updateUI);
  locationInput.addEventListener("input", updateUI);
</script>



{% endblock %}
