{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/confirm_upload.css') }}">
{% endblock %}

{% block content %}

<!-- Environmental Header -->
<div class="header confirm-upload-header confirm-upload-fade-in">
    <div class="row align-items-center justify-content-center text-center">
        <div class="col-md-8">
            <h1 class="confirm-upload-title">
                <div class="confirm-upload-icon">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                {% if edit_mode %}Modifier votre Contribution{% else %}Finaliser votre Contribution{% endif %}
            </h1>
            <p class="confirm-upload-subtitle">
                {% if edit_mode %}
                Mettez à jour les données pour améliorer la surveillance environnementale
                {% else %}
                Vérifiez et validez les informations détectées automatiquement
                {% endif %}
            </p>
        </div>
    </div>
</div>

<!-- Main Content Container -->
<div class="confirm-upload-container confirm-upload-slide-up">
    <h2 class="confirm-upload-page-title">
        {% if edit_mode %}Modifier les métadonnées{% else %}Vérifiez l'image et ses données{% endif %}
    </h2>

    <!-- Image Preview -->
    <div class="confirm-upload-image-preview">
        <img src="{{ url_for('static', filename='uploads/' + filename) }}" 
             class="confirm-upload-image" 
             alt="Image uploadée">
    </div>

    <!-- Form -->
    <form method="POST" action="{{ url_for('main.update_image') if edit_mode else url_for('main.confirm_upload') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% if edit_mode %}
            <input type="hidden" name="image_id" value="{{ image_id }}">
        {% else %}
            <input type="hidden" name="filename" value="{{ filename }}">
        {% endif %}
        <input type="hidden" name="label_manual" id="label_manual">
        <input type="hidden" name="timestamp_manual" id="timestamp_manual">
        <input type="hidden" name="location_manual" id="location_manual">
        <input type="hidden" name="features" id="features" value="{{ features | tojson | safe }}">

        <!-- Label Field -->
        <div class="confirm-upload-form-group">
            <label for="label" class="confirm-upload-form-label">
                <i class="bi bi-trash"></i>État de la poubelle
            </label>
            <div class="confirm-upload-input-row">
                <select name="label" id="label" class="confirm-upload-form-control">
                    <option value="full">Pleine</option>
                    <option value="empty">Vide</option>
                </select>
                <span id="label-badge" class="confirm-upload-badge badge-auto">
                    {{ 'Original' if edit_mode else 'Auto' }}
                </span>
                <button type="button" class="confirm-upload-reset-btn" id="label-reset" disabled>
                    Réinitialiser
                </button>
            </div>
        </div>

        <!-- Timestamp Field -->
        <div class="confirm-upload-form-group">
            <label for="timestamp" class="confirm-upload-form-label">
                <i class="bi bi-clock"></i>Date/Heure
            </label>
            <div class="confirm-upload-input-row">
                <input type="datetime-local" name="timestamp" id="timestamp" class="confirm-upload-form-control">
                <span id="timestamp-badge" class="confirm-upload-badge badge-auto">
                    {{ 'Original' if edit_mode else 'Auto' }}
                </span>
                <button type="button" class="confirm-upload-reset-btn" id="timestamp-reset" disabled>
                    Réinitialiser
                </button>
            </div>
            <div id="timestamp-warning" class="confirm-upload-warning d-none">
                Aucun horodatage détecté automatiquement : veuillez saisir une valeur.
            </div>
        </div>

        <!-- Location Field -->
        <div class="confirm-upload-form-group">
            <label for="location" class="confirm-upload-form-label">
                <i class="bi bi-geo-alt"></i>Localisation
            </label>
            <div class="confirm-upload-input-row">
                <input type="text" name="location" id="location" class="confirm-upload-form-control" 
                       placeholder="Adresse ou coordonnées GPS">
                <span id="location-badge" class="confirm-upload-badge badge-auto">
                    {{ 'Original' if edit_mode else 'Auto' }}
                </span>
                <button type="button" class="confirm-upload-reset-btn" id="location-reset" disabled>
                    Réinitialiser
                </button>
            </div>
            <div id="location-warning" class="confirm-upload-warning d-none">
                Aucune localisation détectée automatiquement : veuillez saisir une valeur.
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="confirm-upload-actions">
            <button type="submit" class="confirm-upload-btn-submit">
                {% if edit_mode %}Enregistrer{% else %}Valider l'image{% endif %}
            </button>
            <a href="{{ url_for('main.upload') }}" class="confirm-upload-btn-cancel">
                Annuler
            </a>
        </div>
    </form>
</div>

<script>
// Valeurs détectées ou existantes injectées côté serveur
const autoLabel      = "{{ auto_label }}";
const autoTimestamp  = "{{ auto_timestamp or '' }}";
const autoLocation   = "{{ auto_location or '' }}";
const baseBadgeText  = "{{ 'Original' if edit_mode else 'Auto' }}";
const features = "{{ features }}";

// Éléments DOM
const labelSelect        = document.getElementById('label');
const timestampInput     = document.getElementById('timestamp');
const locationInput      = document.getElementById('location');

const labelResetBtn      = document.getElementById('label-reset');
const timestampResetBtn  = document.getElementById('timestamp-reset');
const locationResetBtn   = document.getElementById('location-reset');

const labelBadge         = document.getElementById('label-badge');
const timestampBadge     = document.getElementById('timestamp-badge');
const locationBadge      = document.getElementById('location-badge');

const timestampWarning   = document.getElementById('timestamp-warning');
const locationWarning    = document.getElementById('location-warning');

function updateUI(){
  const labelChanged     = labelSelect.value   !== autoLabel;
  const timestampChanged = timestampInput.value!== autoTimestamp;
  const locationChanged  = locationInput.value !== autoLocation;

  const labelManualField     = document.getElementById('label_manual');
  const timestampManualField = document.getElementById('timestamp_manual');
  const locationManualField  = document.getElementById('location_manual');
  labelManualField.value     = labelChanged;
  timestampManualField.value = timestampChanged;
  locationManualField.value  = locationChanged;

  // Update badge text and classes
  labelBadge.textContent      = labelChanged     ? 'Modifié' : baseBadgeText;
  labelBadge.className        = labelChanged     ? 'confirm-upload-badge badge-manual' : 'confirm-upload-badge badge-auto';

  timestampBadge.textContent  = timestampChanged ? 'Modifié' : baseBadgeText;
  timestampBadge.className    = timestampChanged ? 'confirm-upload-badge badge-manual' : 'confirm-upload-badge badge-auto';

  locationBadge.textContent   = locationChanged  ? 'Modifié' : baseBadgeText;
  locationBadge.className     = locationChanged  ? 'confirm-upload-badge badge-manual' : 'confirm-upload-badge badge-auto';

  // Handle "Original" mode
  if (baseBadgeText === 'Original') {
    if (!labelChanged) labelBadge.className = 'confirm-upload-badge badge-original';
    if (!timestampChanged) timestampBadge.className = 'confirm-upload-badge badge-original';
    if (!locationChanged) locationBadge.className = 'confirm-upload-badge badge-original';
  }

  labelResetBtn.disabled      = !labelChanged;
  timestampResetBtn.disabled  = !timestampChanged;
  locationResetBtn.disabled   = !locationChanged;

  const showTimestampWarning = autoTimestamp === '' && timestampInput.value === '';
  const showLocationWarning  = autoLocation  === '' && locationInput.value === '';
  timestampWarning.classList.toggle('d-none', !showTimestampWarning);
  locationWarning.classList.toggle('d-none', !showLocationWarning);
}

function resetLabel(){ labelSelect.value = autoLabel;      updateUI(); }
function resetTimestamp(){ timestampInput.value = autoTimestamp; updateUI(); }
function resetLocation(){ locationInput.value = autoLocation;   updateUI(); }

window.addEventListener('DOMContentLoaded', ()=>{
  labelSelect.value   = autoLabel;
  timestampInput.value= autoTimestamp;
  locationInput.value = autoLocation;
  updateUI();

  // Listeners
  labelSelect.addEventListener('change', updateUI);
  timestampInput.addEventListener('input', updateUI);
  locationInput.addEventListener('input', updateUI);

  // Reset buttons
  labelResetBtn.addEventListener('click', resetLabel);
  timestampResetBtn.addEventListener('click', resetTimestamp);
  locationResetBtn.addEventListener('click', resetLocation);

  /* --------- Autocomplétion d'adresse --------- */
  const suggestionsBox = document.createElement('div');
  suggestionsBox.className = 'confirm-upload-suggestions';
  suggestionsBox.id = 'suggestions';
  document.body.appendChild(suggestionsBox);

  const addrCache = {};
  let addrTimer;

  function showAddrSuggestions(addrs){
    suggestionsBox.innerHTML = '';
    if(addrs.length === 0){
      suggestionsBox.style.display = 'none';
      return;
    }
    addrs.forEach(addr => {
      const div = document.createElement('div');
      div.textContent = addr;
      div.addEventListener('click', () => {
        locationInput.value = addr;
        locationInput.dispatchEvent(new Event('input', { bubbles:true }));
        suggestionsBox.style.display = 'none';
      });
      suggestionsBox.appendChild(div);
    });
    const rect = locationInput.getBoundingClientRect();
    suggestionsBox.style.left   = (rect.left + window.scrollX) + 'px';
    suggestionsBox.style.top    = (rect.bottom + window.scrollY) + 'px';
    suggestionsBox.style.width  = rect.width + 'px';
    suggestionsBox.style.display= 'block';
  }

  function fetchAddr(query){
    if(addrCache[query]){
      showAddrSuggestions(addrCache[query]);
      return;
    }
    fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`)
      .then(res => res.json())
      .then(data => {
        const results = data.features.map(f => f.properties.label);
        addrCache[query] = results;
        showAddrSuggestions(results);
      });
  }

  locationInput.addEventListener('input', (e) => {
    if(!e.isTrusted) return; // Ignorer les modifications programmatiques
    clearTimeout(addrTimer);
    const q = locationInput.value.trim();
    if(q.length < 3){
      suggestionsBox.style.display = 'none';
      return;
    }
    addrTimer = setTimeout(() => fetchAddr(q), 400);
  });

  locationInput.addEventListener('blur', () => {
    setTimeout(() => { suggestionsBox.style.display = 'none'; }, 200);
  });
});
</script>

{% endblock %}