{% extends "base.html" %}
{% block title %}Capture & Upload{% endblock %}
{% block content %}
<div class="cont">
<h2 class="mb-4 text-center">Prendre une photo et l’envoyer</h2>

  <div class="d-flex flex-column align-items-center gap-3">
<!-- Video preview -->

<div class="mb-3">
  <video id="preview" class="w-80 border rounded w-md-75 w-lg-50 mx-auto" playsinline autoplay></video>
  <canvas id="snapshotCanvas" class="d-none w-80 border rounded w-md-75 w-lg-50 mx-auto"></canvas>
</div>


<!-- Form automatically filled by JS -->
<form id="captureForm" method="POST" action="{{ url_for('main.quick_upload') }}" enctype="multipart/form-data">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input type="hidden" name="image" id="imageInput">
  <input type="hidden" name="timestamp" id="timestampInput">
  <input type="hidden" name="location" id="locationInput">
  <input type="hidden" name="label" value="auto">
  <input type="hidden" name="is_manual" value="false">

  <button type="button" id="snapBtn" class="btn btn-primary btn-lg"><i class="bi bi-camera-video me-1"></i> Capturer</button>
</form>
</div>
<script>
(async () => {
  const video  = document.getElementById('preview');
  const canvas = document.getElementById('snapshotCanvas');
  const ctx    = canvas.getContext('2d');
  const btn    = document.getElementById('snapBtn');
  const formEl = document.getElementById('captureForm');

  /* camera */
  const stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'environment'}});
  video.srcObject = stream;

  /* capture */
  btn.addEventListener('click', () => {
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    video.classList.add('d-none');      // hide live preview
    canvas.classList.remove('d-none');

    video.srcObject.getTracks().forEach(t => t.stop());

    canvas.toBlob(async blob => {
      if (!blob) return;

      /* Build body – includes csrf automatically */
      const body = new FormData(formEl);
      body.set('image', blob, `capture_${Date.now()}.jpg`);
      body.set('timestamp', new Date().toISOString().slice(0,16));

      /* optional geo */
      try {
        const g = await new Promise(r => navigator.geolocation.getCurrentPosition(r, () => r(null)));
        if (g) body.set('location', `${g.coords.latitude},${g.coords.longitude}`);
      } catch {}

      /* send */
      const r = await fetch(formEl.action, { method:'POST', body });
      if (r.redirected) window.location = r.url;
    }, 'image/jpeg', .9);
  });
})();
</script>

{% endblock %}
