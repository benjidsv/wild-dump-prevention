{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<h2>üìä Statistiques de tri</h2>

<form method="GET" class="row g-3 mb-4">
  <div class="col-md-4">
    <label for="start_date" class="form-label">Date de d√©but</label>
    <input type="date" id="start_date" name="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}">
  </div>
  <div class="col-md-4">
    <label for="end_date" class="form-label">Date de fin</label>
    <input type="date" id="end_date" name="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}">
  </div>
  <div class="col-md-4 align-self-end">
    <button type="submit" class="btn btn-primary">Filtrer</button>
  </div>
</form>

<canvas id="pieChart" width="300" height="300"></canvas>

<hr class="my-4">

<h2>üó∫Ô∏è Carte des poubelles</h2>
<div id="map" style="height: 500px;"></div>

<!-- Librairies JS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-sA+MqXtn4WY0GPo9F06P9n2v4Uu47aZm4J09snL+8wY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o7c8bGlQkuoS4F4J+WnD2j4ntxPtJ0kY9Q+G2VM+Rqc="
  crossorigin=""
></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// --- Chart.js Camembert ---
const data = {
    labels: ['Pleine', 'Vide'],
    datasets: [{
        data: [{{ stats.full }}, {{ stats.empty }}],
        backgroundColor: ['#dc3545', '#198754']
    }]
};

const config = {
    type: 'pie',
    data: data,
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: 'R√©partition des annotations' }
        }
    }
};

new Chart(document.getElementById('pieChart'), config);

// --- Leaflet Carte ---
const map = L.map('map').setView([46.6, 2.4], 6);  // Centre France

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

// R√©cup√©rer les points depuis Flask (liste d'objets {lat, lon, label})
const locations = {{ locations_coords | tojson }};

// Ajouter un marker par location avec couleur selon label
locations.forEach(loc => {
  const pinColor = loc.label === 'full' ? 'red' :
                   loc.label === 'empty' ? 'green' :
                   'blue';

  const circle = L.circleMarker([loc.lat, loc.lon], {
    radius: 8,
    fillColor: pinColor,
    color: '#000',
    weight: 1,
    opacity: 1,
    fillOpacity: 0.8
  }).addTo(map);

  circle.bindPopup(
    `Statut: <strong>${loc.label}</strong><br>` +
    `Latitude: ${loc.lat.toFixed(5)}<br>` +
    `Longitude: ${loc.lon.toFixed(5)}`
  );
});
</script>

{% endblock %}
