{% extends "base.html" %}
{% block title %}Dashboard - Wild Dump Prevention{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}

<!-- Dashboard Header -->

<div class="header dashboard-header">
    <div class="row align-items-center justify-content-between">
        <div class="col-md-auto">
            <h1 class="page-title text-white">
                <i class="bi bi-images me-3"></i>Tableau de Bord
            </h1>
            <p class="page-subtitle">
                Visualisez les données collectées à l'aide de vos images
            </p>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid fade-in">
  <div class="card stat-card hover-lift">
    <div class="stat-icon green">
      <i class="bi bi-check-circle-fill"></i>
    </div>
    <div class="stat-value">{{ stats.empty|default(0) }}</div>
    <div class="stat-label">Poubelles Vides</div>
  </div>

  <div class="card stat-card hover-lift">
    <div class="stat-icon red">
      <i class="bi bi-exclamation-triangle-fill"></i>
    </div>
    <div class="stat-value">{{ stats.full|default(0) }}</div>
    <div class="stat-label">Poubelles Remplies</div>
  </div>

  <div class="card stat-card hover-lift">
    <div class="stat-icon blue">
      <i class="bi bi-geo-alt-fill"></i>
    </div>
    <div class="stat-value">{{ locations_coords|length|default(0) }}</div>
    <div class="stat-label">Sites Surveillés</div>
  </div>

  <div class="card stat-card hover-lift">
    <div class="stat-icon green">
      <i class="bi bi-percent"></i>
    </div>
    <div class="stat-value">
      {% if stats.empty|default(0) + stats.full|default(0) > 0 %}
        {{ ((stats.empty|default(0) / (stats.empty|default(0) + stats.full|default(0))) * 100)|round|int }}%
      {% else %}
        0%
      {% endif %}
    </div>
    <div class="stat-label">Efficacité du Ramassage</div>
  </div>
</div>

<!-- Filter Section -->
<div class="card filter-card fade-in">
  <div class="filter-header">
    <h3><i class="bi bi-funnel"></i>Filtrer les Données</h3>
  </div>
  <form method="GET" class="row g-3">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="col-md-5">
      <label for="start_date" class="form-label">Date de début</label>
      <input type="date" id="start_date" name="start_date" class="form-control"
             value="{{ request.args.get('start_date', '') }}">
    </div>
    <div class="col-md-5">
      <label for="end_date" class="form-label">Date de fin</label>
      <input type="date" id="end_date" name="end_date" class="form-control"
             value="{{ request.args.get('end_date', '') }}">
    </div>
    <div class="col-md-2 align-self-end">
      <button type="submit" class="btn btn-secondary-custom w-100">
        <i class="bi bi-search"></i> Appliquer
      </button>
    </div>
  </form>
</div>

<!-- Map Section -->
<div class="card map-container fade-in">
  <div class="map-header">
    <h3><i class="bi bi-map" style="color: var(--teal-accent)"></i> Carte des Déchets</h3>
    <div class="btn-group" role="group">
      <button class="btn btn-sm btn-outline-secondary" onclick="resetMapView()">
        <i class="bi bi-arrow-clockwise"></i> Reset
      </button>
      <button class="btn btn-sm btn-outline-secondary" onclick="toggleFullscreen()">
        <i class="bi bi-fullscreen"></i> Plein Écran
      </button>
    </div>
  </div>
  <div id="map">
    <div class="map-loading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Chargement de la carte...</span>
      </div>
      <p class="mt-2 text-muted">Chargement des données...</p>
    </div>
  </div>
</div>

<!-- Charts Grid -->
<div class="charts-grid fade-in">
  <!-- Pie Chart -->
  <div class="card chart-card hover-lift">
    <div class="chart-header">
      <h3>Distribution des Poubelles</h3>
      <span class="badge bg-secondary">Temps-réel</span>
    </div>
    <canvas id="pieChart" width="300" height="300"></canvas>
  </div>

  <!-- Time Series Chart -->
  <div class="card chart-card hover-lift">
    <div class="chart-header">
      <h3>Collection Trends</h3>
      <span class="badge bg-secondary">Last 7 days</span>
    </div>
    <canvas id="lineChart" width="300" height="300"></canvas>
  </div>
</div>

<!-- External Libraries -->
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script defer src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<script>
// Global map variable
let map = null;
let clusters = null;

document.addEventListener('DOMContentLoaded', () => {
  // Chart.js default font
  Chart.defaults.font.family = "'Inter', sans-serif";

  /* --------------------------------------------------------------------------- */
  /* 1. Pie Chart with gradient                                                  */
  /* --------------------------------------------------------------------------- */
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  const pieGradientGreen = pieCtx.createLinearGradient(0, 0, 0, 300);
  pieGradientGreen.addColorStop(0, '#7cb342');
  pieGradientGreen.addColorStop(1, '#a8cc8c');

  const pieGradientRed = pieCtx.createLinearGradient(0, 0, 0, 300);
  pieGradientRed.addColorStop(0, '#dc3545');
  pieGradientRed.addColorStop(1, '#ff6b7a');

  new Chart(pieCtx, {
    type: 'doughnut',
    data: {
      labels: ['Poubelles Vides', 'Poubelles Pleines'],
      datasets: [{
        data: [{{ stats.empty|default(0) }}, {{ stats.full|default(0) }}],
        backgroundColor: [pieGradientGreen, pieGradientRed],
        borderWidth: 0,
        spacing: 2
      }]
    },
    options: {
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            font: { size: 14, weight: '500' },
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(30, 58, 95, 0.9)',
          padding: 12,
          cornerRadius: 8,
          titleFont: { size: 14, weight: '600' },
          bodyFont: { size: 13 }
        }
      },
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%'
    }
  });

  /* --------------------------------------------------------------------------- */
  /* 2. Line Chart - Collection Trends                                           */
  /* --------------------------------------------------------------------------- */
  const lineCtx = document.getElementById('lineChart').getContext('2d');
  const lineGradient = lineCtx.createLinearGradient(0, 0, 0, 300);
  lineGradient.addColorStop(0, 'rgba(74, 155, 142, 0.3)');
  lineGradient.addColorStop(1, 'rgba(74, 155, 142, 0.0)');

  // Sample data - replace with actual time series data
  const last7Days = Array.from({length: 7}, (_, i) => {
    const d = new Date();
    d.setDate(d.getDate() - (6 - i));
    return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
  });

  new Chart(lineCtx, {
    type: 'line',
    data: {
      labels: last7Days,
      datasets: [{
        label: 'Full Bins',
        data: [12, 19, 15, 25, 22, 30, {{ stats.full|default(0) }}],
        borderColor: '#4a9b8e',
        backgroundColor: lineGradient,
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 6,
        pointHoverRadius: 8,
        pointBackgroundColor: '#fff',
        pointBorderColor: '#4a9b8e',
        pointBorderWidth: 2
      }]
    },
    options: {
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(30, 58, 95, 0.9)',
          padding: 12,
          cornerRadius: 8
        }
      },
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          },
          ticks: {
            font: { size: 12 }
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: { size: 12 }
          }
        }
      }
    }
  });

  /* --------------------------------------------------------------------------- */
  /* 3. Enhanced Leaflet Map                                                     */
  /* --------------------------------------------------------------------------- */

  // Hide loading spinner
  setTimeout(() => {
    document.querySelector('.map-loading').style.display = 'none';
  }, 500);

  // Initialize map
  map = L.map('map').setView([46.6, 2.4], 6);

  // Custom tile layer with better colors
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap contributors © CARTO'
  }).addTo(map);

  const locations = {{ locations_coords | tojson | default('[]', true) }};

  // Enhanced icon factory
  const pinIcon = (color, size = 24) => L.divIcon({
    html: `
      <div style="position: relative;">
        <svg width="${size}" height="${size}" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="${color}" stroke="#fff" stroke-width="2"/>
          <circle cx="12" cy="12" r="5" fill="#fff" opacity="0.3"/>
        </svg>
      </div>`,
    className: '',
    iconSize: [size, size],
    iconAnchor: [size/2, size/2]
  });

  // Build markers with enhanced styling
  const markers = [];
  locations.forEach(l => {
    if (!l.lat || !l.lon) return;

    const color = l.label === 'full' ? '#dc3545' :
                  l.label === 'empty' ? '#7cb342' : '#0d6efd';

    const marker = L.marker([l.lat, l.lon], {
      icon: pinIcon(color),
      binState: l.label,
      title: l.label
    }).bindPopup(`
      <div style="min-width: 200px;">
        <h6 style="margin: 0 0 8px 0; color: #1e3a5f;">Bin Status</h6>
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
          <span style="display: inline-block; width: 12px; height: 12px;
                       border-radius: 50%; background: ${color}; margin-right: 8px;"></span>
          <strong style="text-transform: capitalize;">${l.label}</strong>
        </div>
        <div style="font-size: 12px; color: #666;">
          <div>Lat: ${l.lat.toFixed(5)}</div>
          <div>Lon: ${l.lon.toFixed(5)}</div>
        </div>
      </div>
    `, { className: 'custom-popup' });

    markers.push(marker);
  });

  // Enhanced cluster layer
  clusters = L.markerClusterGroup({
    chunkedLoading: true,
    chunkDelay: 25,
    spiderfyDistanceMultiplier: 1.5,
    iconCreateFunction: cluster => {
      const children = cluster.getAllChildMarkers();
      const fullCount = children.filter(m => m.options.binState === 'full').length;
      const ratio = fullCount / children.length;

      let color;
      if (ratio < 0.25) {
        color = 'linear-gradient(135deg, #7cb342, #a8cc8c)';
      } else if (ratio < 0.60) {
        color = 'linear-gradient(135deg, #ffc107, #ffdb4d)';
      } else {
        color = 'linear-gradient(135deg, #dc3545, #ff6b7a)';
      }

      return L.divIcon({
        html: `<div class='cluster-bubble' style='background: ${color}'>${children.length}</div>`,
        className: '',
        iconSize: [48, 48]
      });
    }
  });

  clusters.addLayers(markers);
  map.addLayer(clusters);

  // Individual pins layer
  const pins = L.layerGroup();

  map.on('overlayadd', e => {
    if (e.layer === pins && pins.getLayers().length === 0) {
      markers.forEach(m => pins.addLayer(m));
    }
  });

  map.on('overlayremove', e => {
    if (e.layer === pins) {
      pins.clearLayers();
    }
  });

  // Enhanced legend
  const legend = L.control({ position: 'topright' });
  legend.onAdd = () => {
    const div = L.DomUtil.create('div', 'leaflet-control custom-legend');
    div.innerHTML = `
      <h6 style="margin: 0 0 12px 0; font-weight: 600; color: #1e3a5f;">Zone Status</h6>
      <div class="legend-item">
        <div class="legend-color" style="background: linear-gradient(90deg, #7cb342, #a8cc8c);"></div>
        <span>Zone sans risque</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: linear-gradient(90deg, #ffc107, #ffdb4d);"></div>
        <span>Zone à surveiller</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: linear-gradient(90deg, #dc3545, #ff6b7a);"></div>
        <span>Zone critique</span>
      </div>
    `;
    L.DomEvent.disableClickPropagation(div);
    return div;
  };
  legend.addTo(map);

  // Layer control
  L.control.layers(null, {
    '<i class="bi bi-grid-3x3-gap-fill"></i> Clusters': clusters,
    '<i class="bi bi-geo-alt-fill"></i> Pins': pins
  }, {
    collapsed: false,
    position: 'topright'
  }).addTo(map);

  // Fit map to markers
  if (markers.length) {
    map.fitBounds(clusters.getBounds(), {
      padding: [100, 100],
      maxZoom: 14
    });
  }
});

// Helper functions
function resetMapView() {
  if (map && clusters) {
    map.fitBounds(clusters.getBounds(), {
      padding: [100, 100],
      maxZoom: 14
    });
  }
}

function toggleFullscreen() {
  const mapContainer = document.getElementById('map');
  if (!document.fullscreenElement) {
    mapContainer.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
}
</script>

{% endblock %}