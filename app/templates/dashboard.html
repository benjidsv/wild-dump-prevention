{% extends "base.html" %}
{% block title %}Dashboard - Wild Dump Prevention{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}

<!-- Dashboard Header -->

<div class="header dashboard-header">
    <div class="row align-items-center justify-content-between">
        <div class="col-md-auto">
            <h1 class="page-title text-white">
                <i class="bi bi-images me-3"></i>Tableau de Bord
            </h1>
            <p class="page-subtitle">
                Visualisez les données collectées à l'aide de vos images
            </p>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid fade-in">
  <div class="card stat-card hover-lift">
    <div class="stat-icon green">
      <i class="bi bi-check-circle-fill"></i>
    </div>
    <div class="stat-value">{{ stats.empty|default(0) }}</div>
    <div class="stat-label">Poubelles Vides</div>
  </div>

  <div class="card stat-card hover-lift">
    <div class="stat-icon red">
      <i class="bi bi-exclamation-triangle-fill"></i>
    </div>
    <div class="stat-value">{{ stats.full|default(0) }}</div>
    <div class="stat-label">Poubelles Remplies</div>
  </div>

  <div class="card stat-card hover-lift">
    <div class="stat-icon blue">
      <i class="bi bi-geo-alt-fill"></i>
    </div>
    <div class="stat-value">{{ locations_coords|length|default(0) }}</div>
    <div class="stat-label">Sites Surveillés</div>
  </div>

  <div class="card stat-card hover-lift">
    <div class="stat-icon green">
      <i class="bi bi-percent"></i>
    </div>
    <div class="stat-value">
      {% if stats.empty|default(0) + stats.full|default(0) > 0 %}
        {{ ((stats.empty|default(0) / (stats.empty|default(0) + stats.full|default(0))) * 100)|round|int }}%
      {% else %}
        0%
      {% endif %}
    </div>
    <div class="stat-label">Efficacité du Ramassage</div>
  </div>
</div>

<!-- Filter Section -->
<div class="card filter-card fade-in">
  <div class="filter-header">
    <h3><i class="bi bi-funnel"></i>Filtrer les Données</h3>
  </div>
  <form method="GET" class="row g-3">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="col-md-5">
      <label for="start_date" class="form-label">Date de début</label>
      <input type="date" id="start_date" name="start_date" class="form-control"
             value="{{ request.args.get('start_date', '') }}">
    </div>
    <div class="col-md-5">
      <label for="end_date" class="form-label">Date de fin</label>
      <input type="date" id="end_date" name="end_date" class="form-control"
             value="{{ request.args.get('end_date', '') }}">
    </div>
    <div class="col-md-2 align-self-end">
      <button type="submit" class="btn btn-secondary-custom w-100">
        <i class="bi bi-search"></i> Appliquer
      </button>
    </div>
  </form>
</div>

<!-- Map Section -->
<div class="card map-container fade-in">
  <div class="map-header">
    <h3><i class="bi bi-map" style="color: var(--teal-accent)"></i> Carte des Déchets</h3>
    <div class="btn-group" role="group">
      <button class="btn btn-sm btn-outline-secondary" onclick="resetMapView()">
        <i class="bi bi-arrow-clockwise"></i> Reset
      </button>
      <button class="btn btn-sm btn-outline-secondary" onclick="toggleFullscreen()">
        <i class="bi bi-fullscreen"></i> Plein Écran
      </button>
    </div>
  </div>
  <div id="map">
    <div class="map-loading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Chargement de la carte...</span>
      </div>
      <p class="mt-2 text-muted">Chargement des données...</p>
    </div>
  </div>
</div>

<!-- Charts Grid -->
<div class="charts-grid fade-in">
  <!-- Pie Chart -->
  <div class="card chart-card hover-lift">
    <div class="chart-header">
      <h3>Distribution des Poubelles</h3>
    </div>
    <canvas id="pieChart" width="300" height="300"></canvas>
  </div>

  <!-- Histogram -->
  <div class="card chart-card hover-lift">
    <div class="chart-header">
      <h3>Images ajoutées (7 derniers jours)</h3>
    </div>
    <canvas id="histogramChart" width="300" height="300"></canvas>
  </div>

  <!-- Radar Chart -->
  <div class="card chart-card hover-lift">
    <div class="chart-header">
      <h3>Profil Moyen par Label</h3>
    </div>
    <canvas id="radarChart"></canvas>
  </div>

  <!-- Hourly Chart -->
  <div class="card chart-card hover-lift">
      <div class="chart-header">
          <h3>Répartition par Heure</h3>
      </div>
      <canvas id="hourlyChart"></canvas>
  </div>
</div>

<!-- External Libraries -->
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script defer src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<script>
// Global map variable
let map = null;
let clusters = null;

document.addEventListener('DOMContentLoaded', () => {
  // Chart.js default font
  Chart.defaults.font.family = "'Inter', sans-serif";

  /* --------------------------------------------------------------------------- */
  /* 1. Pie Chart with gradient                                                  */
  /* --------------------------------------------------------------------------- */
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  const pieGradientGreen = pieCtx.createLinearGradient(0, 0, 0, 300);
  pieGradientGreen.addColorStop(0, '#7cb342');
  pieGradientGreen.addColorStop(1, '#a8cc8c');

  const pieGradientRed = pieCtx.createLinearGradient(0, 0, 0, 300);
  pieGradientRed.addColorStop(0, '#dc3545');
  pieGradientRed.addColorStop(1, '#ff6b7a');

  window.pieChart = new Chart(pieCtx, {
    type: 'doughnut',
    data: {
      labels: ['Poubelles Vides', 'Poubelles Pleines'],
      datasets: [{
        data: [{{ stats.empty|default(0) }}, {{ stats.full|default(0) }}],
        backgroundColor: [pieGradientGreen, pieGradientRed],
        borderWidth: 0,
        spacing: 2
      }]
    },
    options: {
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            font: { size: 14, weight: '500' },
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(30, 58, 95, 0.9)',
          padding: 12,
          cornerRadius: 8,
          titleFont: { size: 14, weight: '600' },
          bodyFont: { size: 13 }
        }
      },
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%'
    }
  });

  /* --------------------------------------------------------------------------- */
  /* 3. Histogram - Daily Image Uploads                                          */
  /* --------------------------------------------------------------------------- */
  const histogramCtx = document.getElementById('histogramChart').getContext('2d');
  const histogramLabels = {{ histogram_labels|tojson|safe }};
  const histogramValues = {{ histogram_values|tojson|safe }};

  const histogramGradient = histogramCtx.createLinearGradient(0, 0, 0, 300);
  histogramGradient.addColorStop(0, 'rgba(54, 162, 235, 0.5)');
  histogramGradient.addColorStop(1, 'rgba(54, 162, 235, 0)');

  window.histogramChart = new Chart(histogramCtx, {
    type: 'bar',
    data: {
      labels: histogramLabels,
      datasets: [{
        label: 'Nombre d\'images',
        data: histogramValues,
        backgroundColor: histogramGradient,
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 2,
        borderRadius: 4,
        hoverBackgroundColor: 'rgba(54, 162, 235, 0.7)'
      }]
    },
    options: {
      plugins: {
        legend: { display: false },
        tooltip: {
            backgroundColor: 'rgba(30, 58, 95, 0.9)',
            padding: 12,
            cornerRadius: 8
        }
      },
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(0, 0, 0, 0.05)' },
          ticks: { 
            font: { size: 12 },
            stepSize: 1 
          }
        },
        x: {
          grid: { display: false },
          ticks: { font: { size: 12 } }
        }
      }
    }
  });


  /* --------------------------------------------------------------------------- */
  /* 4. Radar Chart - Average Feature Profile                                    */
  /* --------------------------------------------------------------------------- */
  const radarCtx = document.getElementById('radarChart').getContext('2d');
  const radarData = {{ radar_data|tojson|safe }};

  window.radarChart = new Chart(radarCtx, {
      type: 'radar',
      data: {
          labels: radarData.labels,
          datasets: [{
              label: 'Full',
              data: radarData.datasets.full,
              backgroundColor: 'rgba(220, 53, 69, 0.2)',
              borderColor: 'rgb(220, 53, 69)',
              pointBackgroundColor: 'rgb(220, 53, 69)',
              borderWidth: 2
          }, {
              label: 'Empty',
              data: radarData.datasets.empty,
              backgroundColor: 'rgba(40, 167, 69, 0.2)',
              borderColor: 'rgb(40, 167, 69)',
              pointBackgroundColor: 'rgb(40, 167, 69)',
              borderWidth: 2
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: {
                  position: 'top',
              },
              tooltip: {
                  backgroundColor: 'rgba(30, 58, 95, 0.9)',
                  padding: 12,
                  cornerRadius: 8
              }
          },
          scales: {
              r: {
                  angleLines: {
                      color: 'rgba(0, 0, 0, 0.1)'
                  },
                  grid: {
                      color: 'rgba(0, 0, 0, 0.1)'
                  },
                  pointLabels: {
                      font: {
                          size: 11
                      },
                      color: '#495057'
                  },
                  ticks: {
                      backdropColor: 'rgba(255, 255, 255, 0.75)',
                      color: '#6c757d'
                  }
              }
          }
      }
  });

  /* --------------------------------------------------------------------------- */
  /* 5. Hourly Distribution Chart                                                */
  /* --------------------------------------------------------------------------- */
  const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
  const hourlyLabels = {{ hourly_labels|tojson|safe }};
  const hourlyValues = {{ hourly_values|tojson|safe }};

  const hourlyGradient = hourlyCtx.createLinearGradient(0, 0, 0, 300);
  hourlyGradient.addColorStop(0, 'rgba(255, 159, 64, 0.5)');
  hourlyGradient.addColorStop(1, 'rgba(255, 159, 64, 0)');

  window.hourlyChart = new Chart(hourlyCtx, {
      type: 'line',
      data: {
          labels: hourlyLabels,
          datasets: [{
              label: 'Nombre d\'images',
              data: hourlyValues,
              backgroundColor: hourlyGradient,
              borderColor: 'rgba(255, 159, 64, 1)',
              borderWidth: 2,
              fill: true,
              tension: 0.4
          }]
      },
      options: {
          plugins: {
              legend: { display: false }
          },
          scales: {
              y: {
                  beginAtZero: true,
                  ticks: { stepSize: 1 }
              }
          }
      }
  });


  /* --------------------------------------------------------------------------- */
  /* 6. Enhanced Leaflet Map                                                     */
  /* --------------------------------------------------------------------------- */

  // Hide loading spinner
  setTimeout(() => {
    document.querySelector('.map-loading').style.display = 'none';
  }, 500);

  // Initialize map
  map = L.map('map').setView([46.6, 2.4], 6);

  // Custom tile layer with better colors
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap contributors © CARTO'
  }).addTo(map);

  const locations = {{ locations_coords | tojson | default('[]', true) }};

  // Enhanced icon factory
  const pinIcon = (color, size = 24) => L.divIcon({
    html: `
      <div style="position: relative;">
        <svg width="${size}" height="${size}" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="${color}" stroke="#fff" stroke-width="2"/>
          <circle cx="12" cy="12" r="5" fill="#fff" opacity="0.3"/>
        </svg>
      </div>`,
    className: '',
    iconSize: [size, size],
    iconAnchor: [size/2, size/2]
  });

  // Build markers with enhanced styling
  const markers = [];
  locations.forEach(l => {
    if (!l.lat || !l.lon) return;

    const color = l.label === 'full' ? '#dc3545' :
                  l.label === 'empty' ? '#7cb342' : '#0d6efd';

    const marker = L.marker([l.lat, l.lon], {
      icon: pinIcon(color),
      binState: l.label,
      title: l.label
    }).bindPopup(`
      <div style="min-width: 200px;">
        <h6 style="margin: 0 0 8px 0; color: #1e3a5f;">Bin Status</h6>
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
          <span style="display: inline-block; width: 12px; height: 12px;
                       border-radius: 50%; background: ${color}; margin-right: 8px;"></span>
          <strong style="text-transform: capitalize;">${l.label}</strong>
        </div>
        <div style="font-size: 12px; color: #666;">
          <div>Lat: ${l.lat.toFixed(5)}</div>
          <div>Lon: ${l.lon.toFixed(5)}</div>
        </div>
      </div>
    `, { className: 'custom-popup' });

    markers.push(marker);
  });

  // Enhanced cluster layer
  clusters = L.markerClusterGroup({
    chunkedLoading: true,
    chunkDelay: 25,
    spiderfyDistanceMultiplier: 1.5,
    iconCreateFunction: cluster => {
      const children = cluster.getAllChildMarkers();
      const fullCount = children.filter(m => m.options.binState === 'full').length;
      const ratio = fullCount / children.length;

      let color;
      if (ratio < 0.25) {
        color = 'linear-gradient(135deg, #7cb342, #a8cc8c)';
      } else if (ratio < 0.60) {
        color = 'linear-gradient(135deg, #ffc107, #ffdb4d)';
      } else {
        color = 'linear-gradient(135deg, #dc3545, #ff6b7a)';
      }

      return L.divIcon({
        html: `<div class='cluster-bubble' style='background: ${color}'>${children.length}</div>`,
        className: '',
        iconSize: [48, 48]
      });
    }
  });

  clusters.addLayers(markers);
  map.addLayer(clusters);

  // Individual pins layer
  const pins = L.layerGroup();

  map.on('overlayadd', e => {
    if (e.layer === pins && pins.getLayers().length === 0) {
      markers.forEach(m => pins.addLayer(m));
    }
  });

  map.on('overlayremove', e => {
    if (e.layer === pins) {
      pins.clearLayers();
    }
  });

  // Enhanced legend
  const legend = L.control({ position: 'topright' });
  legend.onAdd = () => {
    const div = L.DomUtil.create('div', 'leaflet-control custom-legend');
    div.innerHTML = `
      <h6 style="margin: 0 0 12px 0; font-weight: 600; color: #1e3a5f;">Zone Status</h6>
      <div class="legend-item">
        <div class="legend-color" style="background: linear-gradient(90deg, #7cb342, #a8cc8c);"></div>
        <span>Zone sans risque</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: linear-gradient(90deg, #ffc107, #ffdb4d);"></div>
        <span>Zone à surveiller</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: linear-gradient(90deg, #dc3545, #ff6b7a);"></div>
        <span>Zone critique</span>
      </div>
    `;
    L.DomEvent.disableClickPropagation(div);
    return div;
  };
  legend.addTo(map);

  // Layer control
  L.control.layers(null, {
    '<i class="bi bi-grid-3x3-gap-fill"></i> Clusters': clusters,
    '<i class="bi bi-geo-alt-fill"></i> Pins': pins
  }, {
    collapsed: false,
    position: 'topright'
  }).addTo(map);

  // Fit map to markers
  if (markers.length) {
    map.fitBounds(clusters.getBounds(), {
      padding: [100, 100],
      maxZoom: 14
    });
  }
});

// Helper functions
function resetMapView() {
  if (map && clusters) {
    map.fitBounds(clusters.getBounds(), {
      padding: [100, 100],
      maxZoom: 14
    });
  }
}

function toggleFullscreen() {
  const mapContainer = document.getElementById('map');
  if (!document.fullscreenElement) {
    mapContainer.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
}
</script>

{% endblock %}

{% block extra_scripts %}
<script>
// WebSocket connection
const socket = io('http://127.0.0.1:8000');

socket.on('connect', function() {
    console.log('Websocket connected!');
});

socket.on('disconnect', function() {
    console.log('Websocket disconnected!');
});

socket.on('connect_error', function(error) {
    console.log('Websocket connection error:', error);
});

socket.on('update', function(data) {
    console.log('Received update:', data);
    
    // Flash message for new image
    const flash_message = `<div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="bi bi-camera-fill me-2"></i>Nouvelle image ajoutée: ${data.filename} (${data.label})
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>`
    document.querySelector('.container').insertAdjacentHTML('afterbegin', flash_message);

    // Update stats if provided
    if (data.stats) {
        const statElements = document.querySelectorAll('.stat-value');
        if (statElements.length >= 4) {
            statElements[0].textContent = data.stats.empty || 0;  // Empty bins
            statElements[1].textContent = data.stats.full || 0;   // Full bins
            statElements[2].textContent = parseInt(statElements[2].textContent) + 1; // Total sites (increment)
            
            // Update efficiency percentage
            const total = (data.stats.empty || 0) + (data.stats.full || 0);
            const efficiency = total > 0 ? Math.round((data.stats.empty / total) * 100) : 0;
            statElements[3].textContent = efficiency + '%';
        }
    }

    // Update charts if they exist
    updateCharts(data.stats);

    // Add new location to map if provided
    if (data.location && map && clusters) {
        addLocationToMap(data.location);
    }

    // Auto-dismiss flash message after 5 seconds
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            if (alert.textContent.includes(data.filename)) {
                alert.remove();
            }
        });
    }, 5000);
});

// Function to update charts
function updateCharts(stats) {
    if (!stats) return;
    
    // Update pie chart if it exists
    if (window.pieChart) {
        window.pieChart.data.datasets[0].data = [stats.empty || 0, stats.full || 0];
        window.pieChart.update();
    }
    
    // Update line chart if it exists
    if (window.lineChart) {
        // Add new data point to line chart
        const currentData = window.lineChart.data.datasets[0].data;
        currentData.push(stats.full || 0);
        
        // Keep only last 7 data points
        if (currentData.length > 7) {
            currentData.shift();
        }
        
        window.lineChart.update();
    }
}

// Function to add location to map
function addLocationToMap(locationData) {
    if (!locationData || !locationData.lat || !locationData.lon) return;
    
    const color = locationData.label === 'full' ? '#dc3545' :
                  locationData.label === 'empty' ? '#7cb342' : '#0d6efd';

    const pinIcon = (color, size = 24) => L.divIcon({
        html: `
          <div style="position: relative;">
            <svg width="${size}" height="${size}" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10" fill="${color}" stroke="#fff" stroke-width="2"/>
              <circle cx="12" cy="12" r="5" fill="#fff" opacity="0.3"/>
            </svg>
          </div>`,
        className: '',
        iconSize: [size, size],
        iconAnchor: [size/2, size/2]
    });

    const marker = L.marker([locationData.lat, locationData.lon], {
        icon: pinIcon(color),
        binState: locationData.label,
        title: locationData.label
    }).bindPopup(`
        <div style="min-width: 200px;">
            <h6 style="margin: 0 0 8px 0; color: #1e3a5f;">Bin Status</h6>
            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                <span style="display: inline-block; width: 12px; height: 12px;
                             border-radius: 50%; background: ${color}; margin-right: 8px;"></span>
                <strong style="text-transform: capitalize;">${locationData.label}</strong>
            </div>
            <div style="font-size: 12px; color: #666;">
                <div>Address: ${locationData.address || 'Unknown'}</div>
                <div>Lat: ${locationData.lat.toFixed(5)}</div>
                <div>Lon: ${locationData.lon.toFixed(5)}</div>
            </div>
        </div>
    `, { className: 'custom-popup' });

    // Add to clusters
    clusters.addLayer(marker);
    
    // Fit map to include new marker
    map.fitBounds(clusters.getBounds(), {
        padding: [50, 50],
        maxZoom: 14
    });
    
    // Flash the new marker
    setTimeout(() => {
        marker.openPopup();
        setTimeout(() => marker.closePopup(), 3000);
    }, 1000);
}
</script>
{% endblock %}