{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<h2>Filtrage</h2>

<form method="GET" class="row g-3 mb-4">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <div class="col-md-4">
    <label for="start_date" class="form-label">Date de début</label>
    <input type="date" id="start_date" name="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}">
  </div>
  <div class="col-md-4">
    <label for="end_date" class="form-label">Date de fin</label>
    <input type="date" id="end_date" name="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}">
  </div>
  <div class="col-md-4 align-self-end">
    <button type="submit" class="btn btn-primary">Filtrer</button>
  </div>
</form>

<h2>Carte des poubelles</h2>
<div id="map" style="height: 500px;"></div>

<hr class="my-4">

<canvas id="pieChart" width="300" height="300"></canvas>

<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ---------- Chart.js ---------- */
  const data = {
    labels: ['Pleine', 'Vide'],
    datasets: [{
      data: [{{ stats.full|default(0) }}, {{ stats.empty|default(0) }}],
      backgroundColor: ['#dc3545', '#198754']
    }]
  };

  new Chart(
    document.getElementById('pieChart'),   // pass the element, not '#id'
    {
      type: 'pie',
      data: data,
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title:  { display: true, text: 'Répartition des annotations' }
        }
      }                 // ← 1st closing brace: options
    }                   // ← 2nd closing brace: outer config
  );                    // ← finishes new Chart(...)

  /* ---------- Leaflet ---------- */
  const map = L.map('map').setView([46.6, 2.4], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  const locations = {{ locations_coords | tojson | default('[]', true) }};
  const latLngs   = [];

  locations.forEach(loc => {
    if (loc.lat == null || loc.lon == null) return;

    const pinColor = loc.label === 'full'  ? 'red'  :
                     loc.label === 'empty' ? 'green': 'blue';

    L.circleMarker([loc.lat, loc.lon], {
      radius: 8,
      fillColor: pinColor,
      color: '#000',
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    })
    .addTo(map)
    .bindPopup(
      `Statut : <strong>${loc.label}</strong><br>` +
      `Lat : ${loc.lat.toFixed(5)}<br>` +
      `Lon : ${loc.lon.toFixed(5)}`
    );

    latLngs.push([loc.lat, loc.lon]);
  });

  if (latLngs.length) {
    map.fitBounds(latLngs, { padding: [20, 20] });
  } else {
    map.setView([46.6, 2.4], 6);
  }

});  /* ← closes DOMContentLoaded callback */
</script>

{% endblock %}
